<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
<title>‰∏âÂπ¥Áîü„ÅÆÊº¢Â≠ó „Éï„É©„ÉÉ„Ç∑„É•„Ç´„Éº„Éâ</title>

<link href="https://fonts.googleapis.com/css2?family=BIZ+UDMincho:wght@400;700&family=BIZ+UDPGothic:wght@400;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f7fafc; --ink:#1f2937; --muted:#6b7280; --card:#ffffff;
    --accent:#2563eb; --accent-ink:#ffffff;
    --chip:#e5e7eb; --chip-on:#dbeafe; --chip-ring:#93c5fd;
    --radius:22px; --shadow:0 10px 30px rgba(0,0,0,.08);
    --ui-font-stack: "BIZ UDPGothic","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    --kyokasho-stack:
      "UD Digi Kyokasho N-R","UD Digi Kyokasho N-B","UD „Éá„Ç∏„Çø„É´ ÊïôÁßëÊõ∏‰Ωì N-R","UD „Éá„Ç∏„Çø„É´ ÊïôÁßëÊõ∏‰Ωì N-B",
      "Yu Kyokasho","YuKyokasho","YuKyokasho Yoko","Hiragino KyoKashotai W3","Hiragino KyoKashotai W6",
      "BIZ UDMincho","Noto Serif JP","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic","Meiryo",sans-serif;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family: var(--ui-font-stack);
    display:flex; align-items:center; justify-content:center; padding:16px;
  }
  .app{width:min(980px,96vw)}
  .panel{
    background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:18px; display:flex; flex-direction:column; gap:14px;
  }
  .top{ display:flex; align-items:center; justify-content:center; gap:10px; }
  .btn{
    appearance:none; border:none; border-radius:14px; padding:12px 18px; font-size:16px; line-height:1; cursor:pointer;
    background:var(--chip); color:var(--ink);
    transition:background .15s ease, color .15s ease, transform .04s ease;
    font-family: var(--ui-font-stack);
  }
  .btn:active{ transform:translateY(1px) }
  .btn.primary{ background:var(--accent); color:var(--accent-ink); }
  .btn.switch.active{ background:var(--accent); color:var(--accent-ink); }
  .btn:disabled{ opacity:.5; cursor:not-allowed }
  .sep{ flex:1 }

  .sheet{ position:fixed; inset:0; background:rgba(0,0,0,.28); display:none; align-items:flex-end; justify-content:center; }
  .sheet.show{ display:flex }
  .sheet-inner{
    width:min(980px,100%); max-height:80vh; overflow:auto;
    background:var(--card); border-radius:20px 20px 0 0; box-shadow:var(--shadow);
    padding:16px 16px 18px; display:flex; flex-direction:column; gap:12px;
  }
  .sheet-head{ display:flex; align-items:center; }
  .sheet-title{ font-weight:700; }
  .sheet-close{ margin-left:auto; background:transparent; border:none; font-size:16px; color:var(--muted); cursor:pointer; }
  .grid{ display:grid; gap:8px; grid-template-columns: repeat(10, 1fr); }
  @media (max-width:640px){ .grid{ grid-template-columns: repeat(8, 1fr); } }
  .chip{
    background:var(--chip); border:none; border-radius:12px; padding:10px 0; cursor:pointer; font-size:18px;
    font-family: var(--kyokasho-stack);
  }
  .chip.on{ background:var(--chip-on); outline:3px solid var(--chip-ring); }
  .sheet-foot{ display:flex; gap:10px; margin-top:6px; }
  .ghost{ background:transparent; border:1px solid #cbd5e1 }

  .card-wrap{ display:none; flex-direction:column; gap:10px; }
  .backlink{ background:transparent; border:none; color:var(--muted); align-self:flex-start; cursor:pointer; padding:6px 6px; }
  .card{
    background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
    padding: clamp(14px, 6vw, 28px);
    display:flex; align-items:center; justify-content:center; gap: clamp(18px, 6vw, 48px);
    min-height: 48vh;
    user-select:none;
  }
  .kanji{
    font-family: var(--kyokasho-stack);
    font-size: clamp(80px, 22vw, 220px);
    line-height:1; letter-spacing: .02em;
    font-feature-settings: "palt" 1;
  }
  .answer{
    min-width: 32%;
    font-size: clamp(22px, 7vw, 42px);
    color: var(--muted);
    visibility: hidden;
    font-family: var(--ui-font-stack);
  }
  .answer.show{ visibility: visible; color: var(--ink); }
  .controls{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:center; }

  .finish{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background:rgba(0,0,0,.12); z-index:50;
  }
  .finish.show{ display:flex; animation: fade 1200ms ease; }
  .finish .box{
    background: var(--card); padding: 18px 22px; border-radius: 16px; box-shadow: var(--shadow);
    font-weight:700; font-size: 20px;
    font-family: var(--ui-font-stack);
  }
  @keyframes fade{ 0%{opacity:0} 15%{opacity:1} 85%{opacity:1} 100%{opacity:0} }
</style>
</head>
<body>
  <div class="app">
    <div class="panel" id="setup">
      <div class="top" aria-hidden="true" style="justify-content:center; font-weight:700;">‰∏âÂπ¥Áîü„ÅÆÊº¢Â≠ó „Éï„É©„ÉÉ„Ç∑„É•„Ç´„Éº„Éâ</div>
      <div class="controls" style="justify-content:center;">
        <button class="btn switch" id="allBtn" aria-label="„Åú„Çì„Å∂">„Åú„Çì„Å∂</button>
        <button class="btn switch" id="pickBtn" aria-label="„Åà„Çâ„Å∂">„Åà„Çâ„Å∂</button>
        <button class="btn switch" id="randomBtn" aria-label="„É©„É≥„ÉÄ„É†20Âïè">„É©„É≥„ÉÄ„É†20Âïè</button>
        <span class="sep"></span>
        <button class="btn primary" id="startBtn">„Çπ„Çø„Éº„Éà</button>
      </div>
    </div>

    <div class="card-wrap" id="play">
      <button class="backlink" id="backBtn">‚Üê „ÇÇ„Å©„Çã</button>
      <div class="card" id="card" role="button" aria-label="„Ç´„Éº„Éâ„Çí„Çø„ÉÉ„Éó">
        <div class="kanji" id="q"></div>
        <div class="answer" id="a"></div>
      </div>
    </div>
  </div>

  <div class="sheet" id="sheet" aria-modal="true" role="dialog">
    <div class="sheet-inner">
      <div class="sheet-head">
        <div class="sheet-title">Êº¢Â≠ó„Çí„Åà„Çâ„Å∂</div>
        <button class="sheet-close" id="closeSheet">„Å®„Åò„Çã ‚úï</button>
      </div>
      <div class="grid" id="grid"></div>
      <div class="sheet-foot">
        <button class="btn ghost" id="clearBtn">ÂÖ®Ëß£Èô§</button>
        <span class="sep"></span>
        <button class="btn primary" id="okBtn">OK</button>
      </div>
    </div>
  </div>

  <div class="finish" id="finish">
    <div class="box">„Åå„Çì„Å∞„Å£„Åü„Å≠üòä</div>
  </div>

<script>
/* --- Â∞èÂ≠¶‰∏âÂπ¥Áîü 200Â≠ó --- */
const KANJI_LIST = [
  "‰∏Å","‰∏ñ","‰∏°","‰∏ª","‰πó","‰∫à","‰∫ã","‰ªï","‰ªñ","‰ª£","‰Ωè","‰Ωø","‰øÇ","ÂÄç","ÂÖ®","ÂÖ∑","ÂÜô","Âàó","Âä©","Âãâ",
  "Âãï","Âãù","Âåñ","Âå∫","Âåª","Âéª","Âèç","Âèñ","Âèó","Âè∑","Âêë","Âêõ","Âë≥","ÂëΩ","Âíå","ÂìÅ","Âì°","ÂïÜ","Âïè","ÂùÇ",
  "Â§Æ","Âßã","Âßî","ÂÆà","ÂÆâ","ÂÆö","ÂÆü","ÂÆ¢","ÂÆÆ","ÂÆø","ÂØí","ÂØæ","Â±Ä","Â±ã","Â≤∏","Â≥∂","Â∑û","Â∏≥","Âπ≥","Âπ∏",
  "Â∫¶","Â∫´","Â∫≠","Âºè","ÂΩπ","ÂæÖ","ÊÄ•","ÊÅØ","ÊÇ™","ÊÇ≤","ÊÉ≥","ÊÑè","ÊÑü","ÊâÄ","Êâì","Êäï","Êãæ","ÊåÅ","Êåá","Êîæ",
  "Êï¥","ÊóÖ","Êóè","Êòî","Êò≠","Êöë","Êöó","Êõ≤","Êúâ","Êúç","Êúü","Êùø","Êü±","Ê†π","Ê§ç","Ê•≠","Êßò","Ê®™","Ê©ã","Ê¨°",
  "Ê≠Ø","Ê≠ª","Ê∞∑","Ê±∫","Ê≤π","Ê≥¢","Ê≥®","Ê≥≥","Ê¥ã","ÊµÅ","Ê∂à","Ê∑±","Ê∏©","Ê∏Ø","Êπñ","ÊπØ","Êº¢","ÁÇ≠","Áâ©",
  "ÁêÉ","Áî±","Áî≥","Áïå","Áïë","ÁóÖ","Áô∫","Áôª","ÁöÆ","Áöø","Áõ∏","Áúå","Áúü","ÁùÄ","Áü≠","Á†î","Á§º","Á•û","Á•≠","Á¶è",
  "Áßí","Á©∂","Á´†","Á´•","Á¨õ","Á¨¨","Á≠Ü","Á≠â","ÁÆ±","Á¥ö","ÁµÇ","Á∑ë","Á∑¥","Áæä","Áæé","Áøí","ËÄÖ","ËÇ≤","Ëã¶","Ëç∑",
  "ËêΩ","Ëëâ","Ëñ¨","Ë°Ä","Ë°®","Ë©©","Ë™ø","Ë´á","Ë±Ü","Ë≤†","Ëµ∑","Ë∑Ø","Ë∫´","Ëª¢","ËªΩ","Ëæ≤","Ëøî","ËøΩ","ÈÄÅ","ÈÄü",
  "ÈÄ≤","ÈÅä","ÈÅã","ÈÉ®","ÈÉΩ","ÈÖç","ÈÖí","Èáç","ÈâÑ","ÈäÄ","Èñã","Èô¢","ÈôΩ","Èöé","ÈõÜ","Èù¢","È°å","È£≤","È§®","ÈßÖ","Èºª"
];

/* „Çà„ÅøÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶Â¢ó„ÇÑ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ */
const READINGS = {
  "‰∏ª":"„Å¨„Åó„Éª„Åó„ÇÖ„Éª„Åä„ÇÇ","‰πó":"„ÅÆ„Çã„Éª„Åò„Çá„ÅÜ","‰∫à":"„Çà","‰∫ã":"„Åì„Å®„Éª„Åò","‰ªï":"„Å§„Åã„Åà„Çã„Éª„Åó",
  "‰ª£":"„Å†„ÅÑ„Éª„Çà","‰Ωè":"„Åô„ÇÄ„Éª„Åò„ÇÖ„ÅÜ","‰Ωø":"„Å§„Åã„ÅÜ„Éª„Åó","‰øÇ":"„Åã„Åã„Çä„Éª„Åë„ÅÑ","ÂÖ®":"„Åú„Çì",
  "ÂÜô":"„ÅÜ„Å§„Åô„Éª„Åó„ÇÉ","Âä©":"„Åü„Åô„Åë„Çã„Éª„Åò„Çá","Âãï":"„ÅÜ„Åî„Åè„Éª„Å©„ÅÜ","Âãù":"„Åã„Å§„Éª„Åó„Çá„ÅÜ","Âåª":"„ÅÑ",
  "Âèñ":"„Å®„Çã","Âèó":"„ÅÜ„Åë„Çã","Âè∑":"„Åî„ÅÜ","Âêõ":"„Åç„Åø„Éª„Åè„Çì","Âë≥":"„ÅÇ„Åò„Éª„Åø","ÂëΩ":"„ÅÑ„ÅÆ„Å°„Éª„ÇÅ„ÅÑ",
  "Âíå":"„Çè","ÂïÜ":"„Åó„Çá„ÅÜ","Âïè":"„ÇÇ„Çì„Éª„Å®„ÅÜ","Âßã":"„ÅØ„Åò„ÇÅ„Çã„Éª„Åó","ÂÆà":"„Åæ„ÇÇ„Çã„Éª„Åó„ÇÖ",
  "ÂÆâ":"„ÇÑ„Åô„ÅÑ„Éª„ÅÇ„Çì","ÂÆö":"„Åï„Å†„ÇÅ„Çã„Éª„Å¶„ÅÑ","ÂÆü":"„Åø„Éª„Åò„Å§","ÂÆ¢":"„Åç„ÇÉ„Åè","ÂÆÆ":"„Åø„ÇÑ„Éª„Åç„ÇÖ„ÅÜ",
  "ÂÆø":"„ÇÑ„Å©„Éª„Åó„ÇÖ„Åè","ÂØí":"„Åï„ÇÄ„ÅÑ„Éª„Åã„Çì","ÂØæ":"„Åü„ÅÑ","Â±ã":"„ÇÑ„Éª„Åä„Åè","Â≥∂":"„Åó„Åæ„Éª„Å®„ÅÜ",
  "Âπ≥":"„Åü„ÅÑ„Çâ„Éª„Å∏„ÅÑ","Âπ∏":"„Åó„ÅÇ„Çè„Åõ„Éª„Åì„ÅÜ","Â∫¶":"„Å©","Â∫≠":"„Å´„Çè„Éª„Å¶„ÅÑ","Âºè":"„Åó„Åç","ÂΩπ":"„ÇÑ„Åè",
  "ÂæÖ":"„Åæ„Å§„Éª„Åü„ÅÑ","ÊÄ•":"„ÅÑ„Åù„Åê„Éª„Åç„ÇÖ„ÅÜ","ÊÅØ":"„ÅÑ„Åç„Éª„Åù„Åè","ÊÇ™":"„Çè„Çã„ÅÑ„Éª„ÅÇ„Åè","ÊÇ≤":"„Åã„Å™„Åó„ÅÑ„Éª„Å≤",
  "ÊÉ≥":"„Åù„ÅÜ","ÊÑè":"„ÅÑ","ÊÑü":"„Åã„Çì","ÊâÄ":"„Å®„Åì„Çç„Éª„Åó„Çá","Êâì":"„ÅÜ„Å§„Éª„Å†","Êäï":"„Å™„Åí„Çã„Éª„Å®„ÅÜ",
  "Êãæ":"„Å≤„Çç„ÅÜ","ÊåÅ":"„ÇÇ„Å§„Éª„Åò","Êåá":"„ÇÜ„Å≥„Éª„Åï„Åô„Éª„Åó","Êîæ":"„ÅØ„Å™„Åô„Éª„Åª„ÅÜ",
  "ÊóÖ":"„Åü„Å≥„Éª„Çä„Çá","Êóè":"„Åû„Åè","Êòî":"„ÇÄ„Åã„Åó","Êöë":"„ÅÇ„Å§„ÅÑ„Éª„Åó„Çá","Êöó":"„Åè„Çâ„ÅÑ„Éª„ÅÇ„Çì",
  "Êúâ":"„ÅÇ„Çã„Éª„ÇÜ„ÅÜ","Êúü":"„Åç","Êùø":"„ÅÑ„Åü„Éª„ÅØ„Çì","Ê†π":"„Å≠„Éª„Åì„Çì","Ê§ç":"„ÅÜ„Åà„Çã„Éª„Åó„Çá„Åè","Ê•≠":"„Åé„Çá„ÅÜ",
  "Êßò":"„Çà„ÅÜ„Éª„Åï„Åæ","Ê®™":"„Çà„Åì„Éª„Åä„ÅÜ","Ê©ã":"„ÅØ„Åó„Éª„Åç„Çá„ÅÜ","Ê¨°":"„Å§„Åé„Éª„Åò","Ê≠Ø":"„ÅØ„Éª„Åó","Ê≠ª":"„Åó„Å¨„Éª„Åó",
  "Ê±∫":"„Åç„ÇÅ„Çã„Éª„Åë„Å§","Ê≤π":"„ÅÇ„Å∂„Çâ„Éª„ÇÜ","Ê≥¢":"„Å™„Åø„Éª„ÅØ","Ê≥®":"„Åù„Åù„Åê„Éª„Å°„ÇÖ„ÅÜ","Ê≥≥":"„Åä„Çà„Åê„Éª„Åà„ÅÑ",
  "Ê¥ã":"„Çà„ÅÜ","ÊµÅ":"„Å™„Åå„Çå„Çã„Éª„Çä„ÇÖ„ÅÜ","Ê∂à":"„Åç„Åà„Çã„Éª„Åë„Åô„Éª„Åó„Çá„ÅÜ","Ê∑±":"„Åµ„Åã„ÅÑ„Éª„Åó„Çì",
  "Ê∏©":"„ÅÇ„Åü„Åü„Åã„ÅÑ„Éª„Åä„Çì","Ê∏Ø":"„Åø„Å™„Å®„Éª„Åì„ÅÜ","Êπñ":"„Åø„Åö„ÅÜ„Åø„Éª„Åì","ÊπØ":"„ÇÜ„Éª„Å®„ÅÜ","Êº¢":"„Åã„Çì",
  "ÁÇ≠":"„Åô„Åø„Éª„Åü„Çì","Áâ©":"„ÇÇ„ÅÆ„Éª„Å∂„Å§","ÁêÉ":"„Åü„Åæ„Éª„Åç„ÇÖ„ÅÜ","Áî≥":"„ÇÇ„ÅÜ„Åô„Éª„Åó„Çì","Áïå":"„Åã„ÅÑ",
  "Áïë":"„ÅØ„Åü„Åë","ÁóÖ":"„ÇÑ„Åæ„ÅÑ„Éª„Å≥„Çá„ÅÜ","Áô∫":"„ÅØ„Å§","Áôª":"„ÅÆ„Åº„Çã„Éª„Å®„ÅÜ","ÁöÆ":"„Åã„Çè„Éª„Å≤","Áöø":"„Åï„Çâ",
  "Áõ∏":"„ÅÇ„ÅÑ„Éª„Åù„ÅÜ","Áúå":"„Åë„Çì","Áúü":"„Åæ„Éª„Åó„Çì","ÁùÄ":"„Åç„Çã„Éª„Å§„Åè„Éª„Å°„ÇÉ„Åè","Áü≠":"„Åø„Åò„Åã„ÅÑ„Éª„Åü„Çì",
  "Á†î":"„Å®„Åê„Éª„Åë„Çì","Á§º":"„Çå„ÅÑ","Á•û":"„Åã„Åø„Éª„Åó„Çì","Á•≠":"„Åæ„Å§„Çä„Éª„Åï„ÅÑ","Á¶è":"„Åµ„Åè","Áßí":"„Å≥„Çá„ÅÜ",
  "Á©∂":"„Åç„Çè„ÇÅ„Çã„Éª„Åç„ÇÖ„ÅÜ","Á´†":"„Åó„Çá„ÅÜ","Á´•":"„Çè„Çâ„Åπ„Éª„Å©„ÅÜ","Á¨õ":"„Åµ„Åà„Éª„Å¶„Åç","Á¨¨":"„Å†„ÅÑ",
  "Á≠Ü":"„Åµ„Åß„Éª„Å≤„Å§","Á≠â":"„Å®„ÅÜ","ÁÆ±":"„ÅØ„Åì","Á¥ö":"„Åç„ÇÖ„ÅÜ","ÁµÇ":"„Åä„Çè„Çã„Éª„Åó„ÇÖ„ÅÜ","Á∑ë":"„Åø„Å©„Çä„Éª„Çä„Çá„Åè",
  "Á∑¥":"„Å≠„Çã„Éª„Çå„Çì","Áæä":"„Å≤„Å§„Åò„Éª„Çà„ÅÜ","Áæé":"„ÅÜ„Å§„Åè„Åó„ÅÑ„Éª„Å≥","Áøí":"„Å™„Çâ„ÅÜ„Éª„Åó„ÇÖ„ÅÜ","ËÄÖ":"„ÇÇ„ÅÆ„Éª„Åó„ÇÉ",
  "ËÇ≤":"„Åù„Å†„Å§„Éª„ÅÑ„Åè","Ëã¶":"„Å´„Åå„ÅÑ„Éª„Åè„Çã„Åó„ÅÑ„Éª„Åè","Ëç∑":"„Å´„Éª„Åã","ËêΩ":"„Åä„Å°„Çã„Éª„Çâ„Åè","Ëëâ":"„ÅØ„Éª„Çà„ÅÜ",
  "Ëñ¨":"„Åè„Åô„Çä„Éª„ÇÑ„Åè","Ë°Ä":"„Å°„Éª„Åë„Å§","Ë°®":"„Åä„ÇÇ„Å¶„Éª„ÅÇ„Çâ„Çè„Åô„Éª„Å≤„Çá„ÅÜ","Ë©©":"„Åó","Ë™ø":"„Åó„Çâ„Åπ„Çã„Éª„Å°„Çá„ÅÜ",
  "Ë´á":"„Å†„Çì","Ë±Ü":"„Åæ„ÇÅ„Éª„Å®„ÅÜ","Ë≤†":"„Åæ„Åë„Çã„Éª„Åä„ÅÜ„Éª„Åµ","Ëµ∑":"„Åä„Åç„Çã„Éª„Åç","Ë∑Ø":"„Åø„Å°„Éª„Çç",
  "Ë∫´":"„Åø„Éª„Åó„Çì","Ëª¢":"„Åì„Çç„Å∂„Éª„Å¶„Çì","ËªΩ":"„Åã„Çã„ÅÑ„Éª„Åë„ÅÑ","Ëæ≤":"„ÅÆ„ÅÜ","Ëøî":"„Åã„Åà„Åô„Éª„Å∏„Çì",
  "ËøΩ":"„Åä„ÅÜ„Éª„Å§„ÅÑ","ÈÄÅ":"„Åä„Åè„Çã„Éª„Åù„ÅÜ","ÈÄü":"„ÅØ„ÇÑ„ÅÑ„Éª„Åù„Åè","ÈÄ≤":"„Åô„Åô„ÇÄ„Éª„Åó„Çì","ÈÅä":"„ÅÇ„Åù„Å∂„Éª„ÇÜ„ÅÜ",
  "ÈÅã":"„ÅØ„Åì„Å∂„Éª„ÅÜ„Çì","ÈÉ®":"„Å∂","ÈÉΩ":"„Åø„ÇÑ„Åì„Éª„Å®","ÈÖç":"„Åè„Å∞„Çã„Éª„ÅØ„ÅÑ","ÈÖí":"„Åï„Åë„Éª„Åó„ÇÖ",
  "Èáç":"„Åä„ÇÇ„ÅÑ„Éª„Åò„ÇÖ„ÅÜ","ÈâÑ":"„Å¶„Å§","ÈäÄ":"„Åé„Çì","Èñã":"„Å≤„Çâ„Åè„Éª„ÅÇ„Åè„Éª„Åã„ÅÑ","Èô¢":"„ÅÑ„Çì","ÈôΩ":"„Å≤„Éª„Çà„ÅÜ",
  "Èöé":"„Åã„ÅÑ","ÈõÜ":"„ÅÇ„Å§„Åæ„Çã„Éª„Åó„ÇÖ„ÅÜ","Èù¢":"„Åä„ÇÇ„Éª„ÇÅ„Çì","È°å":"„Å†„ÅÑ","È£≤":"„ÅÆ„ÇÄ„Éª„ÅÑ„Çì","È§®":"„ÇÑ„Åã„Åü„Éª„Åã„Çì",
  "ÈßÖ":"„Åà„Åç","Èºª":"„ÅØ„Å™„Éª„Å≥"
};

let picked = [];
let order = [];
let idx = 0;
let showAns = false;
let mode = null;

const setup = document.getElementById('setup');
const play = document.getElementById('play');
const qEl = document.getElementById('q');
const aEl = document.getElementById('a');
const card = document.getElementById('card');

const allBtn = document.getElementById('allBtn');
const pickBtn = document.getElementById('pickBtn');
const randomBtn = document.getElementById('randomBtn');
const startBtn = document.getElementById('startBtn');
const backBtn = document.getElementById('backBtn');

const sheet = document.getElementById('sheet');
const grid = document.getElementById('grid');
const okBtn = document.getElementById('okBtn');
const clearBtn = document.getElementById('clearBtn');
const closeSheet = document.getElementById('closeSheet');

const finish = document.getElementById('finish');

updateStartEnable();
setActiveButtons();

/* --- UI handlers --- */
allBtn.addEventListener('click', ()=>{
  picked = [...KANJI_LIST];
  mode = 'all'; setActiveButtons(); flashPickToast(); updateStartEnable();
});

pickBtn.addEventListener('click', ()=>{
  mode = 'pick'; setActiveButtons(); openPicker();
});

/* ‚òÖ „É©„É≥„ÉÄ„É†20Âïè */
randomBtn.addEventListener('click', ()=>{
  picked = sampleUnique(KANJI_LIST, 20);
  mode = 'random20';
  setActiveButtons(); flashPickToast(); updateStartEnable();
});

startBtn.addEventListener('click', ()=>{
  if(picked.length===0){ picked = [...KANJI_LIST]; mode='all'; setActiveButtons(); }
  begin();
});

backBtn.addEventListener('click', ()=>{ endAndReturn(); });

/* „ÇØ„É™„ÉÉ„ÇØ„ÅßÁ≠î„Åà‚ÜíÊ¨°„Å∏ */
card.addEventListener('click', nextOrReveal);

/* ‚òÖ Áü¢Âç∞„Ç≠„ÉºÂØæÂøúÔºàPCÔºâ
   ‚Üí : Á≠î„ÅàË°®Á§∫‚ÜíÊ¨°„Å∏
   ‚Üê : „Å≤„Å®„Å§Êàª„ÇãÔºàÁ≠î„Åà„ÅØÈùûË°®Á§∫„Å´Ôºâ */
window.addEventListener('keydown', (e)=>{
  if (!isPlaying()) return;
  if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') e.preventDefault();
  if (e.key === 'ArrowRight') nextOrReveal();
  if (e.key === 'ArrowLeft') prevOne();
});

/* --- Picker sheet --- */
function openPicker(){
  if(!grid.dataset.ready){
    const frag = document.createDocumentFragment();
    KANJI_LIST.forEach(k=>{
      const b = document.createElement('button');
      b.className = 'chip'; b.textContent = k; b.type='button';
      b.addEventListener('click', ()=> b.classList.toggle('on'));
      frag.appendChild(b);
    });
    grid.appendChild(frag); grid.dataset.ready = '1';
  }
  Array.from(grid.children).forEach(chip=> chip.classList.remove('on'));
  sheet.classList.add('show'); document.body.style.overflow='hidden';
}
closeSheet.addEventListener('click', closePicker);
okBtn.addEventListener('click', ()=>{
  picked = Array.from(grid.children).filter(el=>el.classList.contains('on')).map(el=>el.textContent);
  updateStartEnable(); closePicker();
});
clearBtn.addEventListener('click', ()=>{ Array.from(grid.children).forEach(el=>el.classList.remove('on')); });
function closePicker(){ sheet.classList.remove('show'); document.body.style.overflow=''; }

/* --- Game flow --- */
function begin(){
  order = picked.map(k => KANJI_LIST.indexOf(k)).filter(i=>i>=0);
  if(mode === 'random20'){ shuffle(order); } // „É©„É≥„ÉÄ„É†20Âïè„ÅØÂá∫È°åÈ†Ü„ÇÇ„É©„É≥„ÉÄ„É†
  idx = 0; setup.style.display = 'none'; play.style.display = 'flex'; showQuestion();
}
function showQuestion(){
  const k = KANJI_LIST[order[idx]];
  qEl.textContent = k;
  aEl.textContent = READINGS[k] || "Ôºà„Çà„ÅøÊú™Ë®≠ÂÆöÔºâ";
  showAns = false; aEl.classList.remove('show');
}
function nextOrReveal(){
  if(!showAns){ showAns = true; aEl.classList.add('show'); return; }
  if(idx + 1 >= order.length){ finishRound(); }
  else{ idx++; showQuestion(); }
}
function prevOne(){
  if(idx === 0) return;
  idx--; showQuestion();
}

function finishRound(){
  finish.classList.add('show');
  setTimeout(()=>{ finish.classList.remove('show'); endAndReturn(); }, 1200);
}
function endAndReturn(){
  play.style.display = 'none'; setup.style.display = '';
  idx = 0; showAns = false; aEl.classList.remove('show');
  mode = null; setActiveButtons();
}

/* --- Helpers --- */
function setActiveButtons(){
  allBtn.classList.toggle('active', mode==='all');
  pickBtn.classList.toggle('active', mode==='pick');
  randomBtn.classList.toggle('active', mode==='random20');
}
function flashPickToast(){
  (mode==='random20' ? randomBtn : allBtn).animate(
    [{transform:'scale(1)'},{transform:'scale(1.05)'},{transform:'scale(1)'}],
    {duration:220}
  );
}
function updateStartEnable(){ startBtn.disabled = false; }
function isPlaying(){ return play.style.display === 'flex'; }

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}
function sampleUnique(source, n){
  const copy = [...source];
  shuffle(copy);
  return copy.slice(0, Math.min(n, copy.length));
}
</script>
</body>
</html>
