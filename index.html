<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
<title>ä¸‰å¹´ç”Ÿã®æ¼¢å­— ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰</title>

<link href="https://fonts.googleapis.com/css2?family=BIZ+UDMincho:wght@400;700&family=BIZ+UDPGothic:wght@400;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f7fafc; --ink:#1f2937; --muted:#6b7280; --card:#ffffff;
    --accent:#2563eb; --accent-ink:#ffffff;
    --chip:#e5e7eb; --chip-on:#dbeafe; --chip-ring:#93c5fd;
    --radius:22px; --shadow:0 10px 30px rgba(0,0,0,.08);
    --ui-font-stack: "BIZ UDPGothic","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    --kyokasho-stack:
      "UD Digi Kyokasho N-R","UD Digi Kyokasho N-B","UD ãƒ‡ã‚¸ã‚¿ãƒ« æ•™ç§‘æ›¸ä½“ N-R","UD ãƒ‡ã‚¸ã‚¿ãƒ« æ•™ç§‘æ›¸ä½“ N-B",
      "Yu Kyokasho","YuKyokasho","YuKyokasho Yoko","Hiragino KyoKashotai W3","Hiragino KyoKashotai W6",
      "BIZ UDMincho","Noto Serif JP","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic","Meiryo",sans-serif;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family: var(--ui-font-stack);
    display:flex; align-items:center; justify-content:center; padding:16px;
  }
  .app{width:min(980px,96vw)}
  .panel{
    background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:18px; display:flex; flex-direction:column; gap:14px;
  }
  .top{ display:flex; align-items:center; justify-content:center; gap:10px; }
  .btn{
    appearance:none; border:none; border-radius:14px; padding:12px 18px; font-size:16px; line-height:1; cursor:pointer;
    background:var(--chip); color:var(--ink);
    transition:background .15s ease, color .15s ease, transform .04s ease;
    font-family: var(--ui-font-stack);
  }
  .btn:active{ transform:translateY(1px) }
  .btn.primary{ background:var(--accent); color:var(--accent-ink); }
  .btn.switch.active{ background:var(--accent); color:var(--accent-ink); }
  .btn:disabled{ opacity:.5; cursor:not-allowed }
  .sep{ flex:1 }

  .sheet{ position:fixed; inset:0; background:rgba(0,0,0,.28); display:none; align-items:flex-end; justify-content:center; }
  .sheet.show{ display:flex }
  .sheet-inner{
    width:min(980px,100%); max-height:80vh; overflow:auto;
    background:var(--card); border-radius:20px 20px 0 0; box-shadow:var(--shadow);
    padding:16px 16px 18px; display:flex; flex-direction:column; gap:12px;
  }
  .sheet-head{ display:flex; align-items:center; }
  .sheet-title{ font-weight:700; }
  .sheet-close{ margin-left:auto; background:transparent; border:none; font-size:16px; color:var(--muted); cursor:pointer; }
  .grid{ display:grid; gap:8px; grid-template-columns: repeat(10, 1fr); }
  @media (max-width:640px){ .grid{ grid-template-columns: repeat(8, 1fr); } }
  .chip{
    background:var(--chip); border:none; border-radius:12px; padding:10px 0; cursor:pointer; font-size:18px;
    font-family: var(--kyokasho-stack);
  }
  .chip.on{ background:var(--chip-on); outline:3px solid var(--chip-ring); }
  .sheet-foot{ display:flex; gap:10px; margin-top:6px; }
  .ghost{ background:transparent; border:1px solid #cbd5e1 }

  .card-wrap{ display:none; flex-direction:column; gap:10px; }
  .backlink{ background:transparent; border:none; color:var(--muted); align-self:flex-start; cursor:pointer; padding:6px 6px; }
  .card{
    background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
    padding: clamp(14px, 6vw, 28px);
    display:flex; align-items:center; justify-content:center; gap: clamp(18px, 6vw, 48px);
    min-height: 48vh;
    user-select:none;
  }
  .kanji{
    font-family: var(--kyokasho-stack);
    font-size: clamp(80px, 22vw, 220px);
    line-height:1; letter-spacing: .02em;
    font-feature-settings: "palt" 1;
  }
  .answer{
    min-width: 32%;
    font-size: clamp(22px, 7vw, 42px);
    color: var(--muted);
    visibility: hidden;
    font-family: var(--ui-font-stack);
  }
  .answer.show{ visibility: visible; color: var(--ink); }
  .controls{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:center; }

  .finish{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background:rgba(0,0,0,.12); z-index:50;
  }
  .finish.show{ display:flex; animation: fade 1200ms ease; }
  .finish .box{
    background: var(--card); padding: 18px 22px; border-radius: 16px; box-shadow: var(--shadow);
    font-weight:700; font-size: 20px;
    font-family: var(--ui-font-stack);
  }
  @keyframes fade{ 0%{opacity:0} 15%{opacity:1} 85%{opacity:1} 100%{opacity:0} }
</style>
</head>
<body>
  <div class="app">
    <div class="panel" id="setup">
      <div class="top" aria-hidden="true" style="justify-content:center; font-weight:700;">ä¸‰å¹´ç”Ÿã®æ¼¢å­— ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰</div>
      <div class="controls" style="justify-content:center;">
        <button class="btn switch" id="allBtn" aria-label="ãœã‚“ã¶">ãœã‚“ã¶</button>
        <button class="btn switch" id="pickBtn" aria-label="ãˆã‚‰ã¶">ãˆã‚‰ã¶</button>
        <button class="btn switch" id="randomBtn" aria-label="ãƒ©ãƒ³ãƒ€ãƒ 20å•">ãƒ©ãƒ³ãƒ€ãƒ 20å•</button>
        <span class="sep"></span>
        <button class="btn primary" id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      </div>
    </div>

    <div class="card-wrap" id="play">
      <button class="backlink" id="backBtn">â† ã‚‚ã©ã‚‹</button>
      <div class="card" id="card" role="button" aria-label="ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—">
        <div class="kanji" id="q"></div>
        <div class="answer" id="a"></div>
      </div>
    </div>
  </div>

  <div class="sheet" id="sheet" aria-modal="true" role="dialog">
    <div class="sheet-inner">
      <div class="sheet-head">
        <div class="sheet-title">æ¼¢å­—ã‚’ãˆã‚‰ã¶</div>
        <button class="sheet-close" id="closeSheet">ã¨ã˜ã‚‹ âœ•</button>
      </div>
      <div class="grid" id="grid"></div>
      <div class="sheet-foot">
        <button class="btn ghost" id="clearBtn">å…¨è§£é™¤</button>
        <span class="sep"></span>
        <button class="btn primary" id="okBtn">OK</button>
      </div>
    </div>
  </div>

  <div class="finish" id="finish">
    <div class="box">ãŒã‚“ã°ã£ãŸã­ğŸ˜Š</div>
  </div>

<script>
/* --- å°å­¦ä¸‰å¹´ç”Ÿ 200å­— --- */
const KANJI_LIST = [
  "ä¸","ä¸–","ä¸¡","ä¸»","ä¹—","äºˆ","äº‹","ä»•","ä»–","ä»£","ä½","ä½¿","ä¿‚","å€","å…¨","å…·","å†™","åˆ—","åŠ©","å‹‰",
  "å‹•","å‹","åŒ–","åŒº","åŒ»","å»","å","å–","å—","å·","å‘","å›","å‘³","å‘½","å’Œ","å“","å“¡","å•†","å•","å‚",
  "å¤®","å§‹","å§”","å®ˆ","å®‰","å®š","å®Ÿ","å®¢","å®®","å®¿","å¯’","å¯¾","å±€","å±‹","å²¸","å³¶","å·","å¸³","å¹³","å¹¸",
  "åº¦","åº«","åº­","å¼","å½¹","å¾…","æ€¥","æ¯","æ‚ª","æ‚²","æƒ³","æ„","æ„Ÿ","æ‰€","æ‰“","æŠ•","æ‹¾","æŒ","æŒ‡","æ”¾",
  "æ•´","æ—…","æ—","æ˜”","æ˜­","æš‘","æš—","æ›²","æœ‰","æœ","æœŸ","æ¿","æŸ±","æ ¹","æ¤","æ¥­","æ§˜","æ¨ª","æ©‹","æ¬¡",
  "æ­¯","æ­»","æ°·","æ±º","æ²¹","æ³¢","æ³¨","æ³³","æ´‹","æµ","æ¶ˆ","æ·±","æ¸©","æ¸¯","æ¹–","æ¹¯","æ¼¢","ç‚­","ç‰©",
  "çƒ","ç”±","ç”³","ç•Œ","ç•‘","ç—…","ç™º","ç™»","çš®","çš¿","ç›¸","çœŒ","çœŸ","ç€","çŸ­","ç ”","ç¤¼","ç¥","ç¥­","ç¦",
  "ç§’","ç©¶","ç« ","ç«¥","ç¬›","ç¬¬","ç­†","ç­‰","ç®±","ç´š","çµ‚","ç·‘","ç·´","ç¾Š","ç¾","ç¿’","è€…","è‚²","è‹¦","è·",
  "è½","è‘‰","è–¬","è¡€","è¡¨","è©©","èª¿","è«‡","è±†","è² ","èµ·","è·¯","èº«","è»¢","è»½","è¾²","è¿”","è¿½","é€","é€Ÿ",
  "é€²","éŠ","é‹","éƒ¨","éƒ½","é…","é…’","é‡","é‰„","éŠ€","é–‹","é™¢","é™½","éš","é›†","é¢","é¡Œ","é£²","é¤¨","é§…","é¼»"
];

/* ã‚ˆã¿ï¼ˆå¿…è¦ã«å¿œã˜ã¦å¢—ã‚„ã—ã¦ãã ã•ã„ï¼‰ */
const READINGS = {
  "ä¸»":"ã¬ã—ãƒ»ã—ã‚…ãƒ»ãŠã‚‚","ä¹—":"ã®ã‚‹ãƒ»ã˜ã‚‡ã†","äºˆ":"ã‚ˆ","äº‹":"ã“ã¨ãƒ»ã˜","ä»•":"ã¤ã‹ãˆã‚‹ãƒ»ã—",
  "ä»£":"ã ã„ãƒ»ã‚ˆ","ä½":"ã™ã‚€ãƒ»ã˜ã‚…ã†","ä½¿":"ã¤ã‹ã†ãƒ»ã—","ä¿‚":"ã‹ã‹ã‚Šãƒ»ã‘ã„","å…¨":"ãœã‚“",
  "å†™":"ã†ã¤ã™ãƒ»ã—ã‚ƒ","åŠ©":"ãŸã™ã‘ã‚‹ãƒ»ã˜ã‚‡","å‹•":"ã†ã”ããƒ»ã©ã†","å‹":"ã‹ã¤ãƒ»ã—ã‚‡ã†","åŒ»":"ã„",
  "å–":"ã¨ã‚‹","å—":"ã†ã‘ã‚‹","å·":"ã”ã†","å›":"ãã¿ãƒ»ãã‚“","å‘³":"ã‚ã˜ãƒ»ã¿","å‘½":"ã„ã®ã¡ãƒ»ã‚ã„",
  "å’Œ":"ã‚","å•†":"ã—ã‚‡ã†","å•":"ã‚‚ã‚“ãƒ»ã¨ã†","å§‹":"ã¯ã˜ã‚ã‚‹ãƒ»ã—","å®ˆ":"ã¾ã‚‚ã‚‹ãƒ»ã—ã‚…",
  "å®‰":"ã‚„ã™ã„ãƒ»ã‚ã‚“","å®š":"ã•ã ã‚ã‚‹ãƒ»ã¦ã„","å®Ÿ":"ã¿ãƒ»ã˜ã¤","å®¢":"ãã‚ƒã","å®®":"ã¿ã‚„ãƒ»ãã‚…ã†",
  "å®¿":"ã‚„ã©ãƒ»ã—ã‚…ã","å¯’":"ã•ã‚€ã„ãƒ»ã‹ã‚“","å¯¾":"ãŸã„","å±‹":"ã‚„ãƒ»ãŠã","å³¶":"ã—ã¾ãƒ»ã¨ã†",
  "å¹³":"ãŸã„ã‚‰ãƒ»ã¸ã„","å¹¸":"ã—ã‚ã‚ã›ãƒ»ã“ã†","åº¦":"ã©","åº­":"ã«ã‚ãƒ»ã¦ã„","å¼":"ã—ã","å½¹":"ã‚„ã",
  "å¾…":"ã¾ã¤ãƒ»ãŸã„","æ€¥":"ã„ãããƒ»ãã‚…ã†","æ¯":"ã„ããƒ»ãã","æ‚ª":"ã‚ã‚‹ã„ãƒ»ã‚ã","æ‚²":"ã‹ãªã—ã„ãƒ»ã²",
  "æƒ³":"ãã†","æ„":"ã„","æ„Ÿ":"ã‹ã‚“","æ‰€":"ã¨ã“ã‚ãƒ»ã—ã‚‡","æ‰“":"ã†ã¤ãƒ»ã ","æŠ•":"ãªã’ã‚‹ãƒ»ã¨ã†",
  "æ‹¾":"ã²ã‚ã†","æŒ":"ã‚‚ã¤ãƒ»ã˜","æŒ‡":"ã‚†ã³ãƒ»ã•ã™ãƒ»ã—","æ”¾":"ã¯ãªã™ãƒ»ã»ã†",
  "æ—…":"ãŸã³ãƒ»ã‚Šã‚‡","æ—":"ãã","æ˜”":"ã‚€ã‹ã—","æš‘":"ã‚ã¤ã„ãƒ»ã—ã‚‡","æš—":"ãã‚‰ã„ãƒ»ã‚ã‚“",
  "æœ‰":"ã‚ã‚‹ãƒ»ã‚†ã†","æœŸ":"ã","æ¿":"ã„ãŸãƒ»ã¯ã‚“","æ ¹":"ã­ãƒ»ã“ã‚“","æ¤":"ã†ãˆã‚‹ãƒ»ã—ã‚‡ã","æ¥­":"ãã‚‡ã†",
  "æ§˜":"ã‚ˆã†ãƒ»ã•ã¾","æ¨ª":"ã‚ˆã“ãƒ»ãŠã†","æ©‹":"ã¯ã—ãƒ»ãã‚‡ã†","æ¬¡":"ã¤ããƒ»ã˜","æ­¯":"ã¯ãƒ»ã—","æ­»":"ã—ã¬ãƒ»ã—",
  "æ±º":"ãã‚ã‚‹ãƒ»ã‘ã¤","æ²¹":"ã‚ã¶ã‚‰ãƒ»ã‚†","æ³¢":"ãªã¿ãƒ»ã¯","æ³¨":"ããããƒ»ã¡ã‚…ã†","æ³³":"ãŠã‚ˆããƒ»ãˆã„",
  "æ´‹":"ã‚ˆã†","æµ":"ãªãŒã‚Œã‚‹ãƒ»ã‚Šã‚…ã†","æ¶ˆ":"ããˆã‚‹ãƒ»ã‘ã™ãƒ»ã—ã‚‡ã†","æ·±":"ãµã‹ã„ãƒ»ã—ã‚“",
  "æ¸©":"ã‚ãŸãŸã‹ã„ãƒ»ãŠã‚“","æ¸¯":"ã¿ãªã¨ãƒ»ã“ã†","æ¹–":"ã¿ãšã†ã¿ãƒ»ã“","æ¹¯":"ã‚†ãƒ»ã¨ã†","æ¼¢":"ã‹ã‚“",
  "ç‚­":"ã™ã¿ãƒ»ãŸã‚“","ç‰©":"ã‚‚ã®ãƒ»ã¶ã¤","çƒ":"ãŸã¾ãƒ»ãã‚…ã†","ç”³":"ã‚‚ã†ã™ãƒ»ã—ã‚“","ç•Œ":"ã‹ã„",
  "ç•‘":"ã¯ãŸã‘","ç—…":"ã‚„ã¾ã„ãƒ»ã³ã‚‡ã†","ç™º":"ã¯ã¤","ç™»":"ã®ã¼ã‚‹ãƒ»ã¨ã†","çš®":"ã‹ã‚ãƒ»ã²","çš¿":"ã•ã‚‰",
  "ç›¸":"ã‚ã„ãƒ»ãã†","çœŒ":"ã‘ã‚“","çœŸ":"ã¾ãƒ»ã—ã‚“","ç€":"ãã‚‹ãƒ»ã¤ããƒ»ã¡ã‚ƒã","çŸ­":"ã¿ã˜ã‹ã„ãƒ»ãŸã‚“",
  "ç ”":"ã¨ããƒ»ã‘ã‚“","ç¤¼":"ã‚Œã„","ç¥":"ã‹ã¿ãƒ»ã—ã‚“","ç¥­":"ã¾ã¤ã‚Šãƒ»ã•ã„","ç¦":"ãµã","ç§’":"ã³ã‚‡ã†",
  "ç©¶":"ãã‚ã‚ã‚‹ãƒ»ãã‚…ã†","ç« ":"ã—ã‚‡ã†","ç«¥":"ã‚ã‚‰ã¹ãƒ»ã©ã†","ç¬›":"ãµãˆãƒ»ã¦ã","ç¬¬":"ã ã„",
  "ç­†":"ãµã§ãƒ»ã²ã¤","ç­‰":"ã¨ã†","ç®±":"ã¯ã“","ç´š":"ãã‚…ã†","çµ‚":"ãŠã‚ã‚‹ãƒ»ã—ã‚…ã†","ç·‘":"ã¿ã©ã‚Šãƒ»ã‚Šã‚‡ã",
  "ç·´":"ã­ã‚‹ãƒ»ã‚Œã‚“","ç¾Š":"ã²ã¤ã˜ãƒ»ã‚ˆã†","ç¾":"ã†ã¤ãã—ã„ãƒ»ã³","ç¿’":"ãªã‚‰ã†ãƒ»ã—ã‚…ã†","è€…":"ã‚‚ã®ãƒ»ã—ã‚ƒ",
  "è‚²":"ãã ã¤ãƒ»ã„ã","è‹¦":"ã«ãŒã„ãƒ»ãã‚‹ã—ã„ãƒ»ã","è·":"ã«ãƒ»ã‹","è½":"ãŠã¡ã‚‹ãƒ»ã‚‰ã","è‘‰":"ã¯ãƒ»ã‚ˆã†",
  "è–¬":"ãã™ã‚Šãƒ»ã‚„ã","è¡€":"ã¡ãƒ»ã‘ã¤","è¡¨":"ãŠã‚‚ã¦ãƒ»ã‚ã‚‰ã‚ã™ãƒ»ã²ã‚‡ã†","è©©":"ã—","èª¿":"ã—ã‚‰ã¹ã‚‹ãƒ»ã¡ã‚‡ã†",
  "è«‡":"ã ã‚“","è±†":"ã¾ã‚ãƒ»ã¨ã†","è² ":"ã¾ã‘ã‚‹ãƒ»ãŠã†ãƒ»ãµ","èµ·":"ãŠãã‚‹ãƒ»ã","è·¯":"ã¿ã¡ãƒ»ã‚",
  "èº«":"ã¿ãƒ»ã—ã‚“","è»¢":"ã“ã‚ã¶ãƒ»ã¦ã‚“","è»½":"ã‹ã‚‹ã„ãƒ»ã‘ã„","è¾²":"ã®ã†","è¿”":"ã‹ãˆã™ãƒ»ã¸ã‚“",
  "è¿½":"ãŠã†ãƒ»ã¤ã„","é€":"ãŠãã‚‹ãƒ»ãã†","é€Ÿ":"ã¯ã‚„ã„ãƒ»ãã","é€²":"ã™ã™ã‚€ãƒ»ã—ã‚“","éŠ":"ã‚ãã¶ãƒ»ã‚†ã†",
  "é‹":"ã¯ã“ã¶ãƒ»ã†ã‚“","éƒ¨":"ã¶","éƒ½":"ã¿ã‚„ã“ãƒ»ã¨","é…":"ãã°ã‚‹ãƒ»ã¯ã„","é…’":"ã•ã‘ãƒ»ã—ã‚…",
  "é‡":"ãŠã‚‚ã„ãƒ»ã˜ã‚…ã†","é‰„":"ã¦ã¤","éŠ€":"ãã‚“","é–‹":"ã²ã‚‰ããƒ»ã‚ããƒ»ã‹ã„","é™¢":"ã„ã‚“","é™½":"ã²ãƒ»ã‚ˆã†",
  "éš":"ã‹ã„","é›†":"ã‚ã¤ã¾ã‚‹ãƒ»ã—ã‚…ã†","é¢":"ãŠã‚‚ãƒ»ã‚ã‚“","é¡Œ":"ã ã„","é£²":"ã®ã‚€ãƒ»ã„ã‚“","é¤¨":"ã‚„ã‹ãŸãƒ»ã‹ã‚“",
  "é§…":"ãˆã","é¼»":"ã¯ãªãƒ»ã³"
  "ä¸":"ã¡ã‚‡ã†ãƒ»ã¦ã„",
  "ä¸–":"ã‚ˆãƒ»ã›ãƒ»ã›ã„",
  "ä¸¡":"ã‚Šã‚‡ã†",
  "ä»–":"ã»ã‹ãƒ»ãŸ",
  "å€":"ã°ã„",
  "å…·":"ã",
  "åˆ—":"ã‚Œã¤",
  "å‹‰":"ã¹ã‚“",
  "åŒ–":"ã°ã‘ã‚‹ãƒ»ã‹",
  "åŒº":"ã",
  "å»":"ã•ã‚‹ãƒ»ãã‚‡",
  "å":"ã¯ã‚“ãƒ»ãã‚‹",
  "å‘":"ã‚€ããƒ»ã‚€ã‘ã‚‹ãƒ»ã“ã†",
  "å“":"ã—ãªãƒ»ã²ã‚“",
  "å“¡":"ã„ã‚“",
  "å‚":"ã•ã‹ãƒ»ã¯ã‚“",
  "å¤®":"ãŠã†",
  "å§”":"ã„",
  "å±€":"ãã‚‡ã",
  "å²¸":"ãã—ãƒ»ãŒã‚“",
  "å·":"ã™ãƒ»ã—ã‚…ã†",
  "å¸³":"ã¡ã‚‡ã†",
  "åº«":"ãã‚‰ãƒ»ã“",
  "æ•´":"ã¨ã¨ã®ãˆã‚‹ãƒ»ã›ã„",
  "æ˜­":"ã—ã‚‡ã†",
  "æ›²":"ã¾ãŒã‚‹ãƒ»ãã‚‡ã",
  "æœ":"ãµã",
  "æŸ±":"ã¯ã—ã‚‰ãƒ»ã¡ã‚…ã†",
  "æ°·":"ã“ãŠã‚Šãƒ»ã²ã‚‡ã†",
  "ç”±":"ã‚†ã†"

<script>
};

let picked = [];
let order = [];
let idx = 0;
let showAns = false;
let mode = null;

const setup = document.getElementById('setup');
const play = document.getElementById('play');
const qEl = document.getElementById('q');
const aEl = document.getElementById('a');
const card = document.getElementById('card');

const allBtn = document.getElementById('allBtn');
const pickBtn = document.getElementById('pickBtn');
const randomBtn = document.getElementById('randomBtn');
const startBtn = document.getElementById('startBtn');
const backBtn = document.getElementById('backBtn');

const sheet = document.getElementById('sheet');
const grid = document.getElementById('grid');
const okBtn = document.getElementById('okBtn');
const clearBtn = document.getElementById('clearBtn');
const closeSheet = document.getElementById('closeSheet');

const finish = document.getElementById('finish');

updateStartEnable();
setActiveButtons();

/* --- UI handlers --- */
allBtn.addEventListener('click', ()=>{
  picked = [...KANJI_LIST];
  mode = 'all'; setActiveButtons(); flashPickToast(); updateStartEnable();
});

pickBtn.addEventListener('click', ()=>{
  mode = 'pick'; setActiveButtons(); openPicker();
});

/* â˜… ãƒ©ãƒ³ãƒ€ãƒ 20å• */
randomBtn.addEventListener('click', ()=>{
  picked = sampleUnique(KANJI_LIST, 20);
  mode = 'random20';
  setActiveButtons(); flashPickToast(); updateStartEnable();
});

startBtn.addEventListener('click', ()=>{
  if(picked.length===0){ picked = [...KANJI_LIST]; mode='all'; setActiveButtons(); }
  begin();
});

backBtn.addEventListener('click', ()=>{ endAndReturn(); });

/* ã‚¯ãƒªãƒƒã‚¯ã§ç­”ãˆâ†’æ¬¡ã¸ */
card.addEventListener('click', nextOrReveal);

/* â˜… çŸ¢å°ã‚­ãƒ¼å¯¾å¿œï¼ˆPCï¼‰
   â†’ : ç­”ãˆè¡¨ç¤ºâ†’æ¬¡ã¸
   â† : ã²ã¨ã¤æˆ»ã‚‹ï¼ˆç­”ãˆã¯éè¡¨ç¤ºã«ï¼‰ */
window.addEventListener('keydown', (e)=>{
  if (!isPlaying()) return;
  if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') e.preventDefault();
  if (e.key === 'ArrowRight') nextOrReveal();
  if (e.key === 'ArrowLeft') prevOne();
});

/* --- Picker sheet --- */
function openPicker(){
  if(!grid.dataset.ready){
    const frag = document.createDocumentFragment();
    KANJI_LIST.forEach(k=>{
      const b = document.createElement('button');
      b.className = 'chip'; b.textContent = k; b.type='button';
      b.addEventListener('click', ()=> b.classList.toggle('on'));
      frag.appendChild(b);
    });
    grid.appendChild(frag); grid.dataset.ready = '1';
  }
  Array.from(grid.children).forEach(chip=> chip.classList.remove('on'));
  sheet.classList.add('show'); document.body.style.overflow='hidden';
}
closeSheet.addEventListener('click', closePicker);
okBtn.addEventListener('click', ()=>{
  picked = Array.from(grid.children).filter(el=>el.classList.contains('on')).map(el=>el.textContent);
  updateStartEnable(); closePicker();
});
clearBtn.addEventListener('click', ()=>{ Array.from(grid.children).forEach(el=>el.classList.remove('on')); });
function closePicker(){ sheet.classList.remove('show'); document.body.style.overflow=''; }

/* --- Game flow --- */
function begin(){
  order = picked.map(k => KANJI_LIST.indexOf(k)).filter(i=>i>=0);
  if(mode === 'random20'){ shuffle(order); } // ãƒ©ãƒ³ãƒ€ãƒ 20å•ã¯å‡ºé¡Œé †ã‚‚ãƒ©ãƒ³ãƒ€ãƒ 
  idx = 0; setup.style.display = 'none'; play.style.display = 'flex'; showQuestion();
}
function showQuestion(){
  const k = KANJI_LIST[order[idx]];
  qEl.textContent = k;
  aEl.textContent = READINGS[k] || "ï¼ˆã‚ˆã¿æœªè¨­å®šï¼‰";
  showAns = false; aEl.classList.remove('show');
}
function nextOrReveal(){
  if(!showAns){ showAns = true; aEl.classList.add('show'); return; }
  if(idx + 1 >= order.length){ finishRound(); }
  else{ idx++; showQuestion(); }
}
function prevOne(){
  if(idx === 0) return;
  idx--; showQuestion();
}

function finishRound(){
  finish.classList.add('show');
  setTimeout(()=>{ finish.classList.remove('show'); endAndReturn(); }, 1200);
}
function endAndReturn(){
  play.style.display = 'none'; setup.style.display = '';
  idx = 0; showAns = false; aEl.classList.remove('show');
  mode = null; setActiveButtons();
}

/* --- Helpers --- */
function setActiveButtons(){
  allBtn.classList.toggle('active', mode==='all');
  pickBtn.classList.toggle('active', mode==='pick');
  randomBtn.classList.toggle('active', mode==='random20');
}
function flashPickToast(){
  (mode==='random20' ? randomBtn : allBtn).animate(
    [{transform:'scale(1)'},{transform:'scale(1.05)'},{transform:'scale(1)'}],
    {duration:220}
  );
}
function updateStartEnable(){ startBtn.disabled = false; }
function isPlaying(){ return play.style.display === 'flex'; }

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}
function sampleUnique(source, n){
  const copy = [...source];
  shuffle(copy);
  return copy.slice(0, Math.min(n, copy.length));
}
</script>
</body>
</html>
